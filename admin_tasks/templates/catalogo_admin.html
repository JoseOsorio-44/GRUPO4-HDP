{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script> {# Axios cargado aquí #}
    <meta charset="UTF-8">
    <title>OceanTrack - Inventario</title>
    <link rel="stylesheet" href="{% static 'css/materialize.min.css' %}">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <style>
        /* ESTILOS ORIGINALES DE productos.html */
        .info-navio {
            margin-top: 20px;
            padding: 15px;
            background-color: #e3f2fd;
            border-radius: 5px;
        }
        .tabla-productos {
            margin-top: 20px;
        }
        .tabla-productos tr.selected {
            background-color: #e3f2fd !important;
        }
        
        .file-field .btn {
            margin-top: 10px;
        }
        .fecha-caducidad {
            display: none; /* Oculto por defecto, se muestra solo para provisiones */
        }

        .datepicker-date-display {
            display: none !important; /* Oculta la parte superior del DatePicker */
        }

        /* Estilos para centrar la barra de búsqueda y el botón de agregar */
        .search-filter-row {
            margin-top: 20px;
            display: flex;
            align-items: flex-end; 
            gap: 15px; 
            justify-content: center; 
        }

        .search-filter-row .input-field {
            margin-bottom: 0;
        }
        
        .search-filter-row .btn {
            margin-bottom: 0;
        }
        
        #filtroCategoria + label {
            top: -14px !important;
            font-size: 0.8rem !important;
            transform: translateY(0) scale(0.8) !important;
            -webkit-transform: translateY(0) scale(0.8) !important;
        }

        .search-filter-row .select-wrapper input.select-dropdown {
            margin-bottom: 0 !important;
        }

        #fabAgregarProductoContainer,
        #fabEditarProductoContainer,
        #fabEliminarProductoContainer,
        #fabAlertasContainer {
            position: fixed;
            right: 24px;
            z-index: 1000; /* Aseguramos que estén siempre por encima */
        }

        /* Posiciones específicas para cada botón FAB */
        #fabAgregarProductoContainer {
            bottom: 23px; 
            opacity: 1; /* Siempre visible */
            transform: translateY(0);
            display: block; /* Siempre visible */
        }

        /* INICIO DE LOS CAMBIOS PARA LA POSICIÓN DE FAB ALERTAS */
        #fabAlertasContainer {
            bottom: 85px; /* Nueva posición para Alertas (encima de Agregar) */
            opacity: 1; /* Siempre visible */
            transform: translateY(0);
            display: block; /* Siempre visible */
        }

        #fabEliminarProductoContainer {
            bottom: 147px; /* Nueva posición para Eliminar (encima de Alertas) */
            opacity: 0; /* Oculto por defecto */
            transform: translateY(20px); /* Ligeramente abajo */
            transition: opacity 0.3s ease-out, transform 0.3s ease-out; /* Transición */
            display: none; /* Oculto por defecto */
        }
        
        #fabEditarProductoContainer {
            bottom: 209px; /* Posición para editar (encima de Eliminar) */
            opacity: 0; /* Oculto por defecto */
            transform: translateY(20px); /* Ligeramente abajo */
            transition: opacity 0.3s ease-out, transform 0.3s ease-out; /* Transición */
            display: none; /* Oculto por defecto */
        }
        /* FIN DE LOS CAMBIOS PARA LA POSICIÓN DE FAB ALERTAS */


        /* Estilos para el badge de alertas */
        #alertasBadge {
            position: absolute;
            top: -0px; /* Ajusta la posición vertical del badge */
            right: -0px; /* Ajusta la posición horizontal del badge */
            padding: 4px 8px;
            border-radius: 50%;
            background-color: #F44336; /* Rojo para el badge */
            color: white;
            font-size: 0.8em;
            font-weight: bold;
            display: none; /* Inicialmente oculto si no hay alertas */
        }


        /* Asegurar que los colores de los FABs no se desvanezcan */
        .btn-floating.green {
            background-color: #4CAF50 !important; /* Verde Materialize */
        }
        .btn-floating.blue {
            background-color: #2196F3 !important; /* Azul Materialize */
        }
        .btn-floating.red {
            background-color: #F44336 !important; /* Rojo Materialize */
        }
        .btn-floating.yellow.darken-2 {
            background-color: #FBC02D !important; /* Amarillo oscuro Materialize */
        }
    </style>
</head>
<body>
    <script src="{% static 'js/materialize.min.js' %}"></script> 

    <nav class="blue darken-1">
        <div class="nav-wrapper">
            <a href="{% url 'admin_tasks:admin_view' %}" class="brand-logo">
                <img src="{% static 'images/LogoB.png' %}" alt="OceanTrack" style="height:55px; margin-right: 10px; vertical-align: middle;">
                <span>OceanTrack</span>
            </a>
            <a href="#!" class="brand-logo center">Inventario</a>
            <ul class="right hide-on-med-and-down">
                <li><a href="{% url 'admin_tasks:buques' %}"><i class="material-icons left">directions_boat</i>Volver a Buques</a></li>
                <li><a href="{% url 'inicio:logout' %}"><i class="material-icons right">exit_to_app</i>Salir</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            <div class="col s12 info-navio">
                <h5 id="nombreNavio">{{ buque.nombre_buque }}</h5>
                <p><strong>Matrícula:</strong> {{ buque.matricula_buque }}</p>
                <p id="gerenteNavio"><strong>Gerente Asignado:</strong> {{ buque.carnet_gerente.nombre_gerente|default_if_none:"N/A" }}</p>
            </div>
        </div>

        <div class="row search-filter-row">
            <div class="col s12 m7"> 
                <div class="input-field">
                    <i class="material-icons prefix">search</i>
                    <input id="search" type="text" placeholder="Buscar producto">
                    <label for="search">Buscar</label>
                </div>
            </div>

            <div class="col s12 m3"> 
                <div class="input-field">
                    <select id="filtroCategoria">
                        <option value="" selected>Todas</option>
                        <option value="provision">Provisión</option>
                        <option value="repuesto">Repuesto</option>
                    </select>
                    <label for="filtroCategoria">Categorías</label>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col s12 tabla-productos">
                <table class="striped highlight responsive-table">
                    <thead>
                        <tr>
                            <th></th> 
                            <th>Código</th> 
                            <th>Nombre</th>
                            <th>Tipo</th>
                            <th>Cantidad</th>
                            <th>Stock Mínimo</th>
                            <th>Medida</th> {# Columna de medida a la derecha de Stock Mínimo #}
                        </tr>
                    </thead>
                    <tbody id="tablaProductosBody">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="fabAgregarProductoContainer">
            <a class="btn-floating btn-large green" id="btnAgregarProductoFab">
                <i class="material-icons">add</i>
            </a>
        </div>

        <div id="fabAlertasContainer">
            <a class="btn-floating btn-large yellow darken-2" id="btnAlertasFab">
                <i class="material-icons">warning</i>
                <span id="alertasBadge" class="new badge red" data-badge-caption="">0</span>
            </a>
        </div>

        <div id="fabEliminarProductoContainer">
            <a class="btn-floating btn-large red" id="btnEliminarProductoFab">
                <i class="material-icons">delete</i>
            </a>
        </div>

        <div id="fabEditarProductoContainer">
            <a class="btn-floating btn-large blue modal-trigger" href="#modalProducto" id="btnEditarProductoFab">
                <i class="material-icons">edit</i>
            </a>
        </div>
        <div id="modalProducto" class="modal">
            <div class="modal-content">
                <h4><span id="modalTitle">Nuevo Producto</span></h4>
                <form id="formProducto" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" id="methodField" name="_method">
                    <div class="row">
                        <div class="input-field col s12">
                            <input id="codigoProductoInput" type="text" name="codigo_producto" required> 
                            <label for="codigoProductoInput">Código del Producto</label>
                        </div>
                        <div class="input-field col s12">
                            <input id="nombreProducto" type="text" name="nombre_producto" required>
                            <label for="nombreProducto">Nombre del Producto</label>
                        </div>
                        <div class="input-field col s12">
                            <textarea id="descripcion" class="materialize-textarea" name="descripcion"></textarea>
                            <label for="descripcion">Descripción</label>
                        </div>
                        <div class="input-field col s6">
                            <input id="cantidad" type="number" name="cantidad" required min="0">
                            <label for="cantidad">Cantidad</label>
                        </div>
                        <div class="input-field col s6">
                            <input id="stockMinimo" type="number" name="stock_minimo" required min="0">
                            <label for="stockMinimo">Stock Mínimo</label>
                        </div>
                        <div class="input-field col s12">
                            <select id="medidaProducto" name="medida" required>
                                <option value="" disabled selected>Selecciona la medida</option>
                                <option value="Unidad(es)">Unidad(es)</option>
                                <option value="Libra(as)">Libra(as)</option>
                                <option value="Litro(os)">Litro(os)</option>
                                <option value="Caja(s)">Caja(s)</option>
                                <option value="Paquete(s)">Paquete(s)</option>
                                <option value="Galon(es)">Galon(es)</option>
                                <option value="Metro(s)">Metro(s)</option>
                            </select>
                            <label>Unidad de Medida</label>
                        </div>
                        <div class="input-field col s12">
                            <select id="tipoProducto" name="tipo" required>
                                <option value="" disabled selected>Selecciona el tipo</option>
                                <option value="provision">Provisión</option>
                                <option value="repuesto">Repuesto</option>
                            </select>
                            <label>Tipo de Producto</label>
                        </div>
                        <div class="input-field col s12 fecha-caducidad">
                            <input id="fechaCaducidad" type="text" class="datepicker" name="fecha_caducidad">
                            <label for="fechaCaducidad">Fecha de Caducidad</label>
                        </div>
                        <div class="file-field input-field col s12">
                            <div class="btn">
                                <span>Imagen</span>
                                <input type="file" id="fotoProducto" name="foto_producto" accept="image/*">
                            </div>
                            <div class="file-path-wrapper">
                                <input class="file-path validate" type="text" placeholder="Selecciona una imagen">
                            </div>
                            <p>
                                <label>
                                    <input type="checkbox" class="filled-in" id="eliminarImagenCheckbox" name="eliminar_imagen_checkbox" />
                                    <span>Eliminar imagen actual (si existe)</span>
                                </label>
                            </p>
                            <div id="imagenActualPreview" style="margin-top: 10px;"></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn waves-light green" type="submit" name="action">Guardar 
                            <i class="material-icons right">send</i>
                        </button>
                        <a href="#!" class="modal-close waves-green btn-flat">Cancelar</a>
                    </div>
                </form>
            </div>
        </div>

        {# Modal de Confirmación de Eliminación #}
        <div id="confirmDeleteProductoModal" class="modal">
            <div class="modal-content">
                <h4>Confirmar Eliminación</h4>
                <p>¿Estás seguro de que quieres eliminar el producto "<strong id="productoToDeleteName"></strong>" con Código "<strong id="productoToDeleteId"></strong>"? Esta acción es irreversible.</p>
            </div>
            <div class="modal-footer">
                <a href="#!" class="modal-close waves-green btn-flat">Cancelar</a>
                <a href="#!" id="confirmDeleteProductoBtn" class="waves-effect waves-red btn red">Eliminar</a>
            </div>
        </div>

        <div id="modalAlertas" class="modal">
            <div class="modal-content">
                <h4>Alertas de Inventario</h4>
                <div id="alertasContent">
                    </div>
            </div>
            <div class="modal-footer">
                <a href="#!" class="modal-close waves-green btn-flat">Cerrar</a>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Inicialización de Modales
            var modalProductoElem = document.getElementById('modalProducto');
            var confirmDeleteProductoModalElem = document.getElementById('confirmDeleteProductoModal');
            var modalAlertasElem = document.getElementById('modalAlertas');

            const modalProductoInstance = M.Modal.init(modalProductoElem, {
                onCloseEnd: function() {
                    resetSeleccion();
                }
            });
            const confirmDeleteProductoModalInstance = M.Modal.init(confirmDeleteProductoModalElem);
            const alertasModalInstance = M.Modal.init(modalAlertasElem);


            // Inicialización de selects (Materialize)
            var elemsSelect = document.querySelectorAll('select');
            M.FormSelect.init(elemsSelect);

            // NO SE INICIALIZA NINGÚN FAB CON M.FloatingActionButton.init()
            // Todos los FABs serán controlados directamente por nuestro JS y CSS.

            // Referencias a los contenedores de los FABs
            const fabAgregarProductoContainer = document.getElementById('fabAgregarProductoContainer');
            const fabEditarProductoContainer = document.getElementById('fabEditarProductoContainer');
            const fabEliminarProductoContainer = document.getElementById('fabEliminarProductoContainer');
            const fabAlertasContainer = document.getElementById('fabAlertasContainer');
            
            // Referencias a elementos de los botones FAB
            const btnAgregarProductoFab = document.getElementById('btnAgregarProductoFab');
            const btnEditarProductoFab = document.getElementById('btnEditarProductoFab');
            const btnEliminarProductoFab = document.getElementById('btnEliminarProductoFab'); 
            const btnAlertasFab = document.getElementById('btnAlertasFab');
            const alertasBadge = document.getElementById('alertasBadge');
            const alertasContent = document.getElementById('alertasContent');


            // Referencias a otros elementos del DOM
            const tablaProductosBody = document.getElementById('tablaProductosBody');
            const modalProducto = document.getElementById('modalProducto');
            const modalTitle = document.getElementById('modalTitle');
            const formProducto = document.getElementById('formProducto');
            const codigoProductoInput = document.getElementById('codigoProductoInput');
            const nombreProductoInput = document.getElementById('nombreProducto');
            const descripcionInput = document.getElementById('descripcion');
            const cantidadInput = document.getElementById('cantidad');
            const stockMinimoInput = document.getElementById('stockMinimo');
            const tipoProductoSelect = document.getElementById('tipoProducto');
            const medidaProductoSelect = document.getElementById('medidaProducto'); // Referencia al nuevo select de medida
            const fechaCaducidadInput = document.getElementById('fechaCaducidad');
            const fechaCaducidadDiv = document.querySelector('.fecha-caducidad');
            const fotoProductoInput = document.getElementById('fotoProducto');
            const imagenActualPreview = document.getElementById('imagenActualPreview');
            const eliminarImagenCheckbox = document.getElementById('eliminarImagenCheckbox');
            const methodField = document.getElementById('methodField');

            const searchInput = document.getElementById('search');
            const filtroCategoriaSelect = document.getElementById('filtroCategoria');

            const productoToDeleteNameSpan = document.getElementById('productoToDeleteName');
            const productoToDeleteIdSpan = document.getElementById('productoToDeleteId');
            const confirmDeleteProductoBtn = document.getElementById('confirmDeleteProductoBtn');

            // Variables de estado
            let todosProductos = [];
            let selectedRow = null;
            let isEditing = false;
            // Asegúrate de que matriculaBuque sea una variable de contexto de Django que se pase al template
            const matriculaBuque = "{{ buque.matricula_buque }}";

            // NUEVA VARIABLE DE ESTADO PARA CONTROLAR EL DATEPICKER
            let isDatepickerOpen = false;

            // Funciones para mostrar/ocultar los FABs de editar/eliminar
            function showFabButtons() {
                fabEditarProductoContainer.style.display = 'block';
                fabEliminarProductoContainer.style.display = 'block';
                setTimeout(() => {
                    fabEditarProductoContainer.style.opacity = '1';
                    fabEditarProductoContainer.style.transform = 'translateY(0)';
                    fabEliminarProductoContainer.style.opacity = '1';
                    fabEliminarProductoContainer.style.transform = 'translateY(0)';
                }, 50);
            }

            function hideFabButtons() {
                fabEditarProductoContainer.style.opacity = '0';
                fabEditarProductoContainer.style.transform = 'translateY(20px)';
                fabEliminarProductoContainer.style.opacity = '0';
                fabEliminarProductoContainer.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    fabEditarProductoContainer.style.display = 'none';
                    fabEliminarProductoContainer.style.display = 'none';
                }, 300);
            }

            // Inicialización del Datepicker - AÑADIR onOpen y onClose
            M.Datepicker.init(fechaCaducidadInput, {
                format: 'yyyy-mm-dd',
                autoClose: true,
                i18n: {
                    cancel: 'Cancelar',
                    done: 'Ok',
                    months: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
                    monthsShort: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
                    weekdays: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
                    weekdaysShort: ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'],
                    weekdaysAbbrev: ['D', 'L', 'M', 'M', 'J', 'V', 'S']
                },
                onOpen: function() {
                    isDatepickerOpen = true;
                },
                onClose: function() {
                    isDatepickerOpen = false;
                }
            });

            // Manejador de cambio para el tipo de producto (mostrar/ocultar fecha de caducidad)
            tipoProductoSelect.addEventListener('change', function() {
                if (this.value === 'provision') {
                    fechaCaducidadDiv.style.display = 'block';
                } else {
                    fechaCaducidadDiv.style.display = 'none';
                    fechaCaducidadInput.value = ''; // Limpiar la fecha si no es provisión
                }
            });

            // Función para obtener el token CSRF de las cookies
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            // Configurar Axios para incluir el token CSRF automáticamente
            axios.defaults.headers.common['X-CSRFToken'] = getCookie('csrftoken');

            // Función para cargar productos desde la API
            function cargarProductos() {
                axios.get(`/api/inventario/${matriculaBuque}/productos/`)
                    .then(response => {
                        todosProductos = response.data;
                        aplicarFiltrosYRenderizar();
                        actualizarContadorAlertas();
                    })
                    .catch(error => {
                        console.error("Error al cargar productos:", error.response || error);
                        try {
                            const errorMessage = error.response?.data?.error || error.message || 'Error desconocido al cargar productos.';
                            M.toast({html: 'Error al cargar productos: ' + errorMessage, classes: 'red darken-2'});
                        } catch (toastError) {
                            console.error("Error al mostrar toast:", toastError);
                            // En un entorno real, usarías un modal o un mensaje dentro de la UI
                            // alert('Error al cargar productos. Consulta la consola para más detalles.'); 
                        }
                        // Aseguramos que la tabla no se rompa visualmente si hay un error
                        tablaProductosBody.innerHTML = `<tr><td colspan="7" class="center-align">Error al cargar productos.</td></tr>`;
                        actualizarContadorAlertas(); 
                    });
            }

            // Función para aplicar filtros de búsqueda y categoría
            function aplicarFiltrosYRenderizar() {
                const searchTerm = searchInput.value.toLowerCase().trim();
                const categoriaFiltro = filtroCategoriaSelect.value; 

                const filtered = todosProductos.filter(producto => {
                    const matchesSearch = producto.nombre_producto.toLowerCase().includes(searchTerm) || 
                                          producto.descripcion.toLowerCase().includes(searchTerm) ||
                                          producto.codigo_producto.toLowerCase().includes(searchTerm);
                    
                    const matchesCategory = !categoriaFiltro || String(producto.tipo).trim() === categoriaFiltro;
                    
                    return matchesSearch && matchesCategory; 
                });
                renderizarTabla(filtered);
            }

            // Carga inicial de productos al cargar la página
            cargarProductos();

            // Función para renderizar la tabla con los productos filtrados
            function renderizarTabla(productosAmostrar) {
                tablaProductosBody.innerHTML = '';

                if (todosProductos.length === 0) {
                    tablaProductosBody.innerHTML = `<tr><td colspan="7" class="center-align">No hay productos registrados en este buque.</td></tr>`;
                    return;
                }

                if (productosAmostrar.length === 0) {
                    tablaProductosBody.innerHTML = `<tr><td colspan="7" class="center-align">No hay productos que coincidan con la búsqueda o el filtro.</td></tr>`;
                    return;
                }

                productosAmostrar.forEach(producto => {
                    const row = document.createElement('tr');
                    row.setAttribute('data-id', producto.codigo_producto);
                    row.innerHTML = `
                        <td><i class="material-icons">${producto.tipo.trim() === 'provision' ? 'local_grocery_store' : 'build'}</i></td>
                        <td>${producto.codigo_producto}</td>
                        <td>${producto.nombre_producto}</td>
                        <td>${producto.tipo.trim() === 'provision' ? 'Provisión' : 'Repuesto'}</td>
                        <td>${producto.cantidad}</td>
                        <td>${producto.stock_minimo}</td>
                        <td>${producto.medida || 'N/A'}</td> {# Mostrar la medida #}
                    `;
                    row.addEventListener('click', function() {
                        // Deseleccionar todas las filas primero
                        document.querySelectorAll('#tablaProductosBody tr').forEach(r => {
                            r.classList.remove('selected');
                        });
                        // Seleccionar la fila actual
                        selectedRow = row;
                        selectedRow.classList.add('selected');
                        showFabButtons();
                    });
                    tablaProductosBody.appendChild(row);
                });
                resetSeleccion(); // Deseleccionar cualquier fila después de renderizar
            }

            // Evento para deseleccionar una fila al hacer clic fuera de la tabla/FAB/modal/datepicker
            document.addEventListener('click', function(e) { 
                const clickedInsideTable = e.target.closest('.tabla-productos');
                const clickedInsideFabContainer = e.target.closest('#fabAgregarProductoContainer') ||
                                                  e.target.closest('#fabEditarProductoContainer') ||
                                                  e.target.closest('#fabEliminarProductoContainer') ||
                                                  e.target.closest('#fabAlertasContainer'); 
                const clickedInsideModal = e.target.closest('.modal');
                
                // Si el modal de producto está abierto o el datepicker está abierto, no deseleccionar
                if (modalProductoInstance.isOpen || isDatepickerOpen) {
                    return; // No deseleccionar si el modal de edición está abierto o el datepicker está activo
                }

                if (!clickedInsideTable && !clickedInsideFabContainer && !clickedInsideModal && selectedRow) {
                    // Si el clic no fue en la tabla, ni en un FAB, ni en el modal,
                    // y hay una fila seleccionada, reseteamos la selección.
                    resetSeleccion();
                }
            });

            // Función para resetear la selección de la fila (oculta FABs de editar/eliminar)
            function resetSeleccion() {
                if (selectedRow) {
                    selectedRow.classList.remove('selected');
                }
                selectedRow = null;
                hideFabButtons();
            }


            // Botón "Agregar Producto" en el FAB
            btnAgregarProductoFab.addEventListener('click', function() { 
                isEditing = false;
                modalTitle.textContent = 'Nuevo Producto';
                formProducto.reset();

                // Habilitar y reinicializar selects para crear
                codigoProductoInput.readOnly = false; // El código de producto es editable al crear

                tipoProductoSelect.removeAttribute('disabled');
                medidaProductoSelect.removeAttribute('disabled'); // Habilitar select de medida
                
                M.FormSelect.getInstance(tipoProductoSelect)?.destroy();
                M.FormSelect.getInstance(medidaProductoSelect)?.destroy(); // Destruir instancia de medida
                
                tipoProductoSelect.value = '';
                medidaProductoSelect.value = ''; // Limpiar valor de medida
                
                M.FormSelect.init(tipoProductoSelect);
                M.FormSelect.init(medidaProductoSelect); // Reinicializar select de medida


                fechaCaducidadDiv.style.display = 'none';
                fechaCaducidadInput.value = '';
                imagenActualPreview.innerHTML = '';
                eliminarImagenCheckbox.checked = false;
                eliminarImagenCheckbox.parentElement.style.display = 'none';
                M.updateTextFields(); // Actualizar el estado de los labels de Materialize
                modalProductoInstance.open();
            });

            // Botón "Editar Producto" en el FAB
            btnEditarProductoFab.addEventListener('click', function() {
                if (selectedRow) {
                    isEditing = true;
                    modalTitle.textContent = 'Editar Producto';
                    formProducto.reset();
                    codigoProductoInput.readOnly = true; // El código de producto no se edita

                    const codigoProducto = selectedRow.dataset.id.trim();
                    
                    eliminarImagenCheckbox.parentElement.style.display = 'block';

                    axios.get(`/api/inventario/${matriculaBuque}/productos/${codigoProducto}/`)
                        .then(response => {
                            const producto = response.data;
                            codigoProductoInput.value = producto.codigo_producto ? String(producto.codigo_producto).trim() : '';
                            nombreProductoInput.value = producto.nombre_producto ? String(producto.nombre_producto).trim() : '';
                            descripcionInput.value = producto.descripcion ? String(producto.descripcion).trim() : '';
                            cantidadInput.value = producto.cantidad;
                            stockMinimoInput.value = producto.stock_minimo;
                            
                            // Tipo de producto en modo lectura
                            tipoProductoSelect.setAttribute('disabled', 'disabled');
                            M.FormSelect.getInstance(tipoProductoSelect)?.destroy(); // Destruir instancia
                            tipoProductoSelect.value = producto.tipo ? String(producto.tipo).trim() : '';
                            M.FormSelect.init(tipoProductoSelect); // Reinicializar para mostrar el valor

                            // Medida de producto en modo lectura
                            medidaProductoSelect.setAttribute('disabled', 'disabled'); // Deshabilitar select de medida
                            M.FormSelect.getInstance(medidaProductoSelect)?.destroy(); // Destruir instancia de medida
                            medidaProductoSelect.value = producto.medida ? String(producto.medida).trim() : ''; // Precargar valor de medida
                            M.FormSelect.init(medidaProductoSelect); // Reinicializar select de medida

                            if (producto.tipo.trim() === 'provision') {
                                fechaCaducidadDiv.style.display = 'block';
                                fechaCaducidadInput.value = producto.fecha_caducidad;
                            } else {
                                fechaCaducidadDiv.style.display = 'none';
                                fechaCaducidadInput.value = '';
                            }

                            if (producto.imagen_url) {
                                imagenActualPreview.innerHTML = `<p>Imagen actual:</p><img src="${producto.imagen_url}" width="100" height="100" style="object-fit: cover;">`;
                            } else {
                                imagenActualPreview.innerHTML = '';
                            }
                            fotoProductoInput.value = '';
                            eliminarImagenCheckbox.checked = false;

                            M.updateTextFields(); // Actualizar el estado de los labels de Materialize
                            modalProductoInstance.open();
                        })
                        .catch(error => {
                            console.error("Error al cargar producto para editar (Axios):", error.response || error);
                            try {
                                const errorMessage = error.response?.data?.error || error.message || 'Error desconocido al cargar producto.';
                                M.toast({html: 'Error al cargar producto: ' + errorMessage, classes: 'red darken-2'});
                            } catch (toastError) {
                                console.error("Error al mostrar toast:", toastError);
                            }
                        });
                } else {
                    M.toast({html: 'Selecciona un producto para editar', classes: 'orange darken-3'});
                }
            });

            // Botón "Eliminar Producto" en el FAB
            btnEliminarProductoFab.addEventListener('click', function() {
                if (selectedRow) {
                    const codigoProducto = selectedRow.dataset.id.trim();
                    const nombreProducto = selectedRow.cells[2].textContent; // Nombre del producto en la columna 2
                    
                    productoToDeleteNameSpan.textContent = nombreProducto;
                    productoToDeleteIdSpan.textContent = codigoProducto;
                    confirmDeleteProductoModalInstance.open();
                } else {
                    M.toast({html: 'Selecciona un producto para eliminar', classes: 'orange darken-3'});
                }
            });

            // Confirmar eliminación del producto
            confirmDeleteProductoBtn.addEventListener('click', function() {
                if (selectedRow) {
                    const codigoProducto = selectedRow.dataset.id.trim();
                    const formData = new FormData();
                    formData.append('_method', 'DELETE');

                    axios.post(`/api/inventario/${matriculaBuque}/productos/${codigoProducto}/`, formData)
                        .then(response => {
                            M.toast({html: response.data?.message || 'Producto eliminado exitosamente', classes: 'green darken-2'});
                            confirmDeleteProductoModalInstance.close();
                            cargarProductos();
                            resetSeleccion();
                        })
                        .catch(error => {
                            console.error("Delete failed error (Axios POST):", error.response || error);
                            try {
                                const errorMessage = error.response?.data?.error || error.message || 'Error desconocido al eliminar producto.';
                                M.toast({html: 'Error al eliminar producto: ' + errorMessage, classes: 'red darken-2'});
                            } catch (toastError) {
                                console.error("Error al mostrar toast:", toastError);
                            }
                            confirmDeleteProductoModalInstance.close();
                        });
                }
            });

            // Manejador de envío del formulario (Crear/Editar Producto)
            formProducto.addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(formProducto);
                
                // Aseguramos que los valores de los selects, incluso si están disabled, se envíen
                // Para el caso de tipo, como no se edita, se usa el valor que se precargó.
                formData.set('tipo', tipoProductoSelect.value);
                formData.set('medida', medidaProductoSelect.value); // Añadir el valor de medida

                if (tipoProductoSelect.value === 'provision' && fechaCaducidadInput.value) {
                    formData.set('fecha_caducidad', fechaCaducidadInput.value);
                } else if (tipoProductoSelect.value !== 'provision') {
                    formData.delete('fecha_caducidad'); // Eliminar si no es provisión
                }

                const fileInput = document.getElementById('fotoProducto');
                if (fileInput.files.length > 0) {
                    formData.append('foto_producto', fileInput.files[0]);
                } else if (isEditing && eliminarImagenCheckbox.checked) {
                    formData.set('foto_producto', ''); // Si se marca eliminar, enviar vacío
                } else if (isEditing && fileInput.files.length === 0 && !eliminarImagenCheckbox.checked) {
                    // Si no se sube nueva imagen y no se marca eliminar, no enviar el campo de foto
                    formData.delete('foto_producto');
                }

                if (isEditing) {
                    if (!selectedRow) {
                        M.toast({html: 'Error: No hay producto seleccionado para actualizar.', classes: 'red darken-2'});
                        modalProductoInstance.close();
                        return;
                    }
                    const codigoProductoToUpdate = selectedRow.dataset.id.trim();
                    formData.append('_method', 'PUT'); // Simular PUT con POST

                    axios.post(`/api/inventario/${matriculaBuque}/productos/${codigoProductoToUpdate}/`, formData)
                        .then(response => {
                            const message = response.data?.message || 'Producto actualizado exitosamente';
                            M.toast({html: message, classes: 'green darken-2'});
                            modalProductoInstance.close();
                            cargarProductos();
                        })
                        .catch(error => {
                            console.error("Update failed error (Axios POST):", error.response || error);
                            const errors = error.response?.data?.errors;
                            try {
                                if (errors) {
                                    let errorMessages = Object.values(errors).flat().join('<br>');
                                    M.toast({html: errorMessages, classes: 'red darken-2'});
                                } else {
                                    const errorMessage = error.response?.data?.error || error.message || 'Error desconocido al actualizar producto.';
                                    M.toast({html: 'Error al actualizar producto: ' + errorMessage, classes: 'red darken-2'});
                                }
                            } catch (toastError) {
                                console.error("Error al mostrar toast:", toastError);
                            }
                        });
                } else { // Creación
                    axios.post(`/api/inventario/${matriculaBuque}/productos/`, formData)
                        .then(response => {
                            const message = response.data?.message || 'Producto creado exitosamente';
                            M.toast({html: message, classes: 'green darken-2'});
                            modalProductoInstance.close();
                            cargarProductos();
                        })
                        .catch(error => {
                            console.error("Create failed error (Axios POST):", error.response || error);
                            const errors = error.response?.data?.errors;
                            try {
                                if (errors) {
                                    let errorMessages = Object.values(errors).flat().join('<br>');
                                    M.toast({html: errorMessages, classes: 'red darken-2'});
                                } else {
                                    const errorMessage = error.response?.data?.error || error.message || 'Error desconocido al crear producto.';
                                    M.toast({html: 'Error al crear producto: ' + errorMessage, classes: 'red darken-2'});
                                }
                            } catch (toastError) {
                                console.error("Error al mostrar toast:", toastError);
                            }
                        });
                }
            });

            // Eventos para filtros de búsqueda y categoría
            searchInput.addEventListener('input', aplicarFiltrosYRenderizar);
            filtroCategoriaSelect.addEventListener('change', aplicarFiltrosYRenderizar);

            // Funciones proporcionadas para alertas
            function actualizarContadorAlertas() {
                const productosBajos = todosProductos.filter(p => p.cantidad <= p.stock_minimo); 
                const productosCaducados = todosProductos.filter(p => {
                    if (p.tipo.trim().toLowerCase() === 'provision' && p.fecha_caducidad) { 
                        const hoy = new Date();
                        const caducidad = new Date(p.fecha_caducidad);
                        hoy.setHours(0, 0, 0, 0);
                        caducidad.setHours(0, 0, 0, 0);
                        return caducidad <= hoy; 
                    }
                    return false;
                });
                
                const totalAlertas = productosBajos.length + productosCaducados.length;
                if (totalAlertas > 0) {
                    alertasBadge.textContent = totalAlertas;
                    alertasBadge.style.display = 'block';
                } else {
                    alertasBadge.textContent = '0';
                    alertasBadge.style.display = 'none';
                }
            }

            function mostrarAlertasModal() {
                const productosBajos = todosProductos.filter(p => p.cantidad <= p.stock_minimo); 
                const productosCaducados = todosProductos.filter(p => {
                    if (p.tipo.trim().toLowerCase() === 'provision' && p.fecha_caducidad) { 
                        const hoy = new Date();
                        const caducidad = new Date(p.fecha_caducidad);
                        hoy.setHours(0, 0, 0, 0);
                        caducidad.setHours(0, 0, 0, 0);
                        return caducidad <= hoy; 
                    }
                    return false;
                });

                let mensajeAlertas = '';

                if (productosBajos.length > 0) {
                    mensajeAlertas += `<h6>Productos bajo stock mínimo (${productosBajos.length}):</h6>`;
                    mensajeAlertas += `<ul class="collection">`;
                    productosBajos.forEach(p => {
                        mensajeAlertas += `<li class="collection-item"><strong>${p.nombre_producto}</strong>: Quedan ${p.cantidad} (Stock Mínimo: ${p.stock_minimo})</li>`;
                    });
                    mensajeAlertas += `</ul>`;
                }
                
                if (productosCaducados.length > 0) {
                    if (mensajeAlertas) mensajeAlertas += '<br>';
                    mensajeAlertas += `<h6>Productos caducados (${productosCaducados.length}):</h6>`;
                    mensajeAlertas += `<ul class="collection">`;
                    productosCaducados.forEach(p => {
                        mensajeAlertas += `<li class="collection-item"><strong>${p.nombre_producto}</strong>: Caducado el ${p.fecha_caducidad}</li>`;
                    });
                    mensajeAlertas += `</ul>`;
                }

                if (mensajeAlertas) {
                    alertasContent.innerHTML = mensajeAlertas;
                    alertasModalInstance.open();
                } else {
                    M.toast({html: 'No hay alertas de productos en este momento.', classes: 'green'});
                }
            }

            // Evento para el botón flotante de Alertas
            btnAlertasFab.addEventListener('click', mostrarAlertasModal);
        });
    </script>
</body>
</html>