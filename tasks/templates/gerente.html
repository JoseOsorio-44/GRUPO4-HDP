{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <meta charset="UTF-8">
    <title>OceanTrack - Gerente</title>
    <link rel="stylesheet" href="{% static 'css/materialize.min.css' %}">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <style>
        .tabla-gerentes {
            margin-top: 20px;
        }
        .tabla-gerentes tr.selected {
            background-color: #e3f2fd !important;
        }
        #btnEditarGerente {
            display: none;
        }
        .toast.red {
            background-color: #ef5350 !important;
        }
        .toast.green {
            background-color: #66bb6a !important;
        }
        .toast.blue.darken-1 {
            background-color: #1976d2 !important;
        }
        .toast.light-blue {
            background-color: #29b6f6 !important;
        }
        .toast.light-green {
            background-color: #8bc34a !important;
        }

        .input-field {
            position: relative;
        }
        .input-field .toggle-password {
            position: absolute;
            right: 0;
            top: 10px;
            cursor: pointer;
            color: #9e9e9e;
            z-index: 2;
        }
        .input-field input:focus + label + .toggle-password {
            color: #2196F3;
        }

        input[type="password"]::-ms-reveal,
        input[type="password"]::-webkit-reveal-password-button {
            display: none !important;
            -webkit-appearance: none;
        }

        input[type="password"]::-ms-clear,
        input[type="password"]::-webkit-contacts-auto-fill-button {
            display: none !important;
            -webkit-appearance: none;
        }

        .tabla-gerentes table {
            table-layout: fixed;
            width: 100%;
        }

        .tabla-gerentes th,
        .tabla-gerentes td {
            text-align: left;
            padding: 12px 15px;
            vertical-align: middle;
        }

        .tabla-gerentes th:nth-child(1),
        .tabla-gerentes td:nth-child(1) {
            width: 5%;
            text-align: center;
        }

        .tabla-gerentes th:nth-child(2),
        .tabla-gerentes td:nth-child(2) {
            width: 40%;
        }

        .tabla-gerentes th:nth-child(3),
        .tabla-gerentes td:nth-child(3) {
            width: 20%;
        }
        
        .tabla-gerentes th:nth-child(4),
        .tabla-gerentes td:nth-child(4) {
            width: 40%;
        }
        .no-results-message {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #757575;
        }

        input[readonly]:not(.browser-default) {
            background-color: transparent !important; 
            border-bottom: 1px solid #9e9e9e !important; 
            color: rgba(0, 0, 0, 0.87) !important; 
        }
        /* Para que el label flote correctamente con el input readonly */
        .input-field input[readonly]:not(.browser-default) + label {
            transform: translateY(-14px) scale(0.8) !important;
            -webkit-transform: translateY(-14px) scale(0.8) !important;
            transform-origin: 0 0;
            -webkit-transform-origin: 0 0;
        }
    </style>
</head>

<body>
    <script src="{% static 'js/materialize.min.js' %}"></script>

<nav class="blue darken-1">
    <div class="nav-wrapper">
        <a href="{% url 'admin_view' %}" class="brand-logo">
            <img src="{% static 'images/LogoB.png' %}" alt="OceanTrack" style="height:55px; margin-right: 10px; vertical-align: middle;">
            <span>OceanTrack</span>
        </a>
        <a href="#!" class="brand-logo center">Gerentes</a>
        <ul class="right hide-on-med-and-down">
            <li><a href="{% url 'buques' %}"><i class="material-icons left">directions_boat</i>Navios</a></li>
            <li><a href="{% url 'logout' %}"><i class="material-icons right">exit_to_app</i>Salir</a></li>
        </ul>
    </div>
</nav>
    <div class="container">
        <div class="row" style="margin-top: 20px;">
            <div class="col s12 m6">
                <div class="input-field">
                    <i class="material-icons prefix">search</i>
                    <input id="search" type="text" placeholder="Buscar gerente">
                    <label for="search">Buscar</label>
                </div>
            </div>

            <div class="col s12 m6">
                <div class="right-align">
                    <a id="btnEditarGerente" class="waves-effect waves-light btn blue">
                        <i class="material-icons left">search</i>Ver informacion
                    </a>
                    <a class="waves-effect waves-light btn teal modal-trigger" href="#modalGerente" id="btnAgregarGerente">
                        <i class="material-icons left">add</i>Agregar Gerente
                    </a>
                </div>
            </div>
        </div>

        <div class="row tabla-gerentes">
            <div class="col s12">
                <table class="highlight">
                    <thead>
                        <tr>
                            <th></th>
                            <th>Nombre</th>
                            <th>Carnet</th>
                            <th>Email</th>
                        </tr>
                    </thead>
                    <tbody id="tablaGerentes">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modalGerente" class="modal">
        <div class="modal-content">
            <h5 id="modalTitulo">Agregar gerente</h5>
            <form id="formGerente" action="{% url 'api_gerente_list_create' %}" method="post">
                {% csrf_token %}
                <input type="hidden" id="originalCarnetGerente"> 

                <div class="input-field">
                    <input id="carnetGerente" name="carnet_gerente" type="text" required>
                    <label for="carnetGerente">Carnet del Gerente</label>
                </div>

                <div class="input-field">
                    <input id="nombreGerente" name="nombre" type="text" required>
                    <label for="nombreGerente">Nombre del gerente</label>
                </div>

                <div class="input-field">
                    <input id="passGerente" name="password" type="password">
                    <label for="passGerente">Contraseña</label>
                    <span toggle="#passGerente" class="material-icons prefix right field-icon toggle-password">visibility</span>
                </div>

                <div class="input-field">
                    <input id="emailGerente" name="email" type="email" required>
                    <label for="emailGerente">Email</label>
                </div>
            </form>
        </div>

        <div class="modal-footer">
            <a id="btnEliminarGerente" class="waves-effect waves-light btn red left" style="display: none;">
                <i class="material-icons left">delete</i>Eliminar
            </a>
            <button type="submit" form="formGerente" class="waves-effect waves-light btn">
                <span id="btnAccion">Registrar</span>
            </button>
            <a href="#!" class="modal-close waves-effect btn-flat">Cancelar</a>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        var modales = document.querySelectorAll('.modal');
        M.Modal.init(modales);

        axios.defaults.xsrfCookieName = 'csrftoken';
        axios.defaults.xsrfHeaderName = 'X-CSRFToken';

        let gerentes = [];
        let gerenteSeleccionado = null;

        const tablaGerentes = document.getElementById('tablaGerentes');
        const formGerente = document.getElementById('formGerente');
        const btnEditar = document.getElementById('btnEditarGerente');
        const modalTitulo = document.getElementById('modalTitulo');
        const btnAccion = document.getElementById('btnAccion');
        const originalCarnetGerenteInput = document.getElementById('originalCarnetGerente');
        const carnetGerenteInput = document.getElementById('carnetGerente');
        const nombreGerenteInput = document.getElementById('nombreGerente');
        const passGerenteInput = document.getElementById('passGerente');
        const emailGerenteInput = document.getElementById('emailGerente');
        const btnEliminar = document.getElementById('btnEliminarGerente');
        const searchInput = document.getElementById('search'); 
        const btnAgregarGerente = document.getElementById('btnAgregarGerente');
        
        const togglePasswordIcons = document.querySelectorAll('.toggle-password');

        cargarGerentes();

        tablaGerentes.addEventListener('click', function(e) {
            const fila = e.target.closest('tr');
            // MODIFICACIÓN: Usa la clase 'no-data-row' consistentemente para evitar selección
            if (!fila || fila.classList.contains('no-data-row')) { 
                resetSeleccion();
                return;
            }

            document.querySelectorAll('#tablaGerentes tr').forEach(row => {
                row.classList.remove('selected');
            });

            fila.classList.add('selected');
            gerenteSeleccionado = gerentes.find(g => g.carnet_gerente == fila.dataset.carnet);

            btnEditar.style.display = 'inline-block';
            btnEliminar.style.display = 'inline-block'; // Asegúrate de que el botón de eliminar se muestre al seleccionar
        });

        btnEditar.addEventListener('click', function() {
            if (!gerenteSeleccionado) return;

            modalTitulo.textContent = 'Información del Gerente';
            btnAccion.textContent = 'Actualizar';
            btnEliminar.style.display = 'inline-block';

            originalCarnetGerenteInput.value = gerenteSeleccionado.carnet_gerente;
            carnetGerenteInput.value = gerenteSeleccionado.carnet_gerente.trim();
            nombreGerenteInput.value = gerenteSeleccionado.nombre.trim();
            
            passGerenteInput.value = gerenteSeleccionado.contrasenia ? gerenteSeleccionado.contrasenia.trim() : ''; 
            
            emailGerenteInput.value = gerenteSeleccionado.email.trim();

            carnetGerenteInput.readOnly = true; 
            
            passGerenteInput.type = 'password';
            const currentToggleIcon = passGerenteInput.parentElement.querySelector('.toggle-password');
            if (currentToggleIcon) {
                currentToggleIcon.textContent = 'visibility';
            }

            M.updateTextFields();

            const modal = M.Modal.getInstance(document.getElementById('modalGerente'));
            modal.open();
        });

        btnEliminar.addEventListener('click', function() {
            if (!gerenteSeleccionado) return;
        
            if (confirm(`¿Estás seguro de eliminar al gerente ${gerenteSeleccionado.nombre} con carnet ${gerenteSeleccionado.carnet_gerente}?`)) {
                axios.delete(`/api/gerentes/${gerenteSeleccionado.carnet_gerente}/`)
                    .then(response => {
                        M.toast({html: 'Gerente eliminado exitosamente', classes: 'green'});
                        const modal = M.Modal.getInstance(document.getElementById('modalGerente'));
                        modal.close();
                        cargarGerentes();
                        resetSeleccion();
                    })
                    .catch(error => {
                        console.error('Error eliminando gerente:', error);
                        const errorMessage = error.response && error.response.data && error.response.data.error ? error.response.data.error : 'Error al eliminar gerente';
                        // MODIFICACIÓN: Mensaje más específico si el error es por asignación de buque.
                        if (error.response && error.response.data && error.response.data.error && error.response.data.error.includes("No puede eliminar un gerente asignado a un buque")) {
                            M.toast({html: "No se puede eliminar este gerente porque está asignado a un buque.", classes: 'red'});
                        } else {
                            M.toast({html: `Error: ${errorMessage}`, classes: 'red'});
                        }
                    });
            }
        });

        togglePasswordIcons.forEach(icon => {
            icon.addEventListener('click', function() {
                const targetId = this.getAttribute('toggle');
                const inputToToggle = document.querySelector(targetId);

                if (inputToToggle) {
                    const type = inputToToggle.getAttribute('type') === 'password' ? 'text' : 'password';
                    inputToToggle.setAttribute('type', type);
                    this.textContent = (type === 'password') ? 'visibility' : 'visibility_off';
                } else {
                    console.error("Error: No se encontró el input de contraseña para alternar la visibilidad.");
                }
            });
        });

        formGerente.addEventListener('submit', function(e) {
            e.preventDefault();

            const carnet = carnetGerenteInput.value.trim();
            const originalCarnet = originalCarnetGerenteInput.value.trim();
            const nombre = nombreGerenteInput.value.trim();
            const password = passGerenteInput.value.trim();
            const email = emailGerenteInput.value.trim();
            
            const esEdicion = originalCarnet !== ''; 
            let carnet_para_url = ''; 
            let url = '';
            let metodo = '';

            if (!carnet || !nombre || !email) {
                M.toast({html: 'Carnet, nombre y email son obligatorios.', classes: 'red'});
                return;
            }

            if (!esEdicion) {
                metodo = 'post';
                url = '/api/gerentes/'; 
                if (!password) { 
                    M.toast({html: 'La contraseña es obligatoria para nuevos gerentes.', classes: 'red'});
                    return;
                }
            } else { 
                metodo = 'put';
                carnet_para_url = originalCarnet; 
                url = `/api/gerentes/${carnet_para_url}/`;
            }

            const gerenteData = {
                carnet_gerente: carnet,
                nombre: nombre,
                password: (esEdicion && !password) ? undefined : password, 
                email: email,
                tipo_usuario: 'gerente'
            };

            axios({
                method: metodo,
                url: url,
                data: gerenteData
            })
            .then(response => {
                M.toast({html: `Gerente ${esEdicion ? 'actualizado' : 'registrado'} exitosamente`, classes: 'green'});
                const modal = M.Modal.getInstance(document.getElementById('modalGerente'));
                modal.close();
                formGerente.reset();
                M.updateTextFields();
                cargarGerentes();
                resetSeleccion();
            })
            .catch(error => {
                console.error('Error en la operación del gerente:', error.response ? error.response.data : error.message);
                let errorMessage = 'Verifique la consola para detalles';
                if (error.response && error.response.data && error.response.data.error) {
                    errorMessage = error.response.data.error;
                } else if (error.response && error.response.status === 409) {
                    errorMessage = "El carnet de gerente ya existe. Por favor, use uno diferente.";
                }
                M.toast({html: `Error al ${esEdicion ? 'actualizar' : 'registrar'} gerente: ` + errorMessage, classes: 'red'});
            });
        });

        function cargarGerentes() {
            axios.get('/api/gerentes/')
                .then(response => {
                    gerentes = response.data;
                    renderizarTabla();
                })
                .catch(error => {
                    console.error('Error cargando gerentes:', error.response ? error.response.data : error.message);
                    M.toast({html: 'Error al cargar gerentes', classes: 'red'});
                    // MODIFICACIÓN: Usar 'no-data-row' y 'center-align'
                    tablaGerentes.innerHTML = `<tr><td colspan="4" class="no-data-row center-align">Error al cargar gerentes. Intente de nuevo más tarde.</td></tr>`;
                });
        }

        function renderizarTabla() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            const filteredGerentes = gerentes.filter(gerente =>
                gerente.nombre.toLowerCase().includes(searchTerm) ||
                gerente.carnet_gerente.toLowerCase().includes(searchTerm) ||
                gerente.email.toLowerCase().includes(searchTerm)
            );

            tablaGerentes.innerHTML = ''; // Limpiar la tabla antes de renderizar

            if (filteredGerentes.length === 0) {
                const tr = document.createElement('tr');
                // MODIFICACIÓN: Añadir las clases 'no-data-row' y 'center-align'
                tr.classList.add('no-data-row'); 
                tr.classList.add('center-align'); 

                let message = '';
                if (searchTerm === '') {
                    message = 'No hay gerentes registrados en el sistema.';
                } else {
                    message = 'No hay gerentes que coincidan con la búsqueda.';
                }

                // MODIFICACIÓN: Asegurar que el colspan cubra todas las columnas (4 en este caso)
                tr.innerHTML = `<td colspan="4">${message}</td>`; 
                tablaGerentes.appendChild(tr);
            } else {
                tablaGerentes.innerHTML = filteredGerentes.map(gerente => `
                    <tr data-carnet="${gerente.carnet_gerente}">
                        <td><i class="material-icons">person</i></td>
                        <td>${gerente.nombre}</td>
                        <td>${gerente.carnet_gerente}</td>
                        <td>${gerente.email}</td>
                    </tr>
                `).join('');
            }

            resetSeleccion();
        }

        btnAgregarGerente.addEventListener('click', function() {
            modalTitulo.textContent = 'Agregar gerente';
            btnAccion.textContent = 'Registrar';
            btnEliminar.style.display = 'none';
            formGerente.reset();
            originalCarnetGerenteInput.value = '';
            carnetGerenteInput.readOnly = false;
            
            passGerenteInput.type = 'password';
            const currentToggleIcon = passGerenteInput.parentElement.querySelector('.toggle-password');
            if (currentToggleIcon) {
                currentToggleIcon.textContent = 'visibility';
            }
            M.updateTextFields();
        });

        searchInput.addEventListener('input', function() {
            renderizarTabla();
        });

        function resetSeleccion() {
            gerenteSeleccionado = null;
            document.querySelectorAll('#tablaGerentes tr').forEach(row => {
                row.classList.remove('selected');
            });
            btnEditar.style.display = 'none';
            btnEliminar.style.display = 'none'; // Asegúrate de que el botón de eliminar también se oculte
        }
    });
</script>
</body>
</html>