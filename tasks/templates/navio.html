{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <meta charset="UTF-8">
    <title>OceanTrack - Navíos</title>
    <link rel="stylesheet" href="{% static 'css/materialize.min.css' %}">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <style>
        .tabla-navios {
            margin-top: 20px;
        }
        .tabla-navios tr.selected {
            background-color: #e3f2fd !important; /* Materialize Light Blue accent-1 */
        }
        /* Los botones se mostrarán/ocultarán con JS */
        #btnEditarNavio, #btnInventario {
            display: none; 
        }
        /* Estilos de Toast si los tienes definidos */
        .toast.red {
            background-color: #ef5350 !important;
        }
        .toast.green {
            background-color: #66bb6a !important;
        }
    </style>
</head>

<body>
    <script src="{% static 'js/materialize.min.js' %}"></script>

    <nav class="blue darken-1">
        <div class="nav-wrapper">
            <a href="{% url 'admin_view' %}" class="brand-logo">
              <img src="{% static 'images/LogoB.png' %}" alt="OceanTrack" style="height:55px; margin-left:14px; margin-top:6px;">
            <span style="margin-left: 10px; font-size: 2.5rem; position: relative; top: -14px;">OceanTrack</span>
            </a>
            <a href="#!" class="brand-logo center">Navios</a>
            <ul class="right hide-on-med-and-down">
                <li><a href="{% url 'admin_view' %}"><i class="material-icons left">people</i>Gerentes</a></li>
                <li><a href="{% url 'logout' %}"><i class="material-icons right">exit_to_app</i>Salir</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div class="row" style="margin-top: 20px;">
            <div class="col s12 m6">
                <div class="input-field">
                    <i class="material-icons prefix">search</i>
                    <input id="search" type="text" placeholder="Buscar navío">
                    <label for="search">Buscar</label>
                </div>
            </div>

            <div class="col s12 m6">
                <div class="right-align">
                    <a id="btnEditarNavio" class="waves-effect waves-light btn blue">
                        <i class="material-icons left">search</i>Ver información
                    </a>
                    <a id="btnAgregarNavio" class="waves-effect waves-light btn teal">
                        <i class="material-icons left">add</i>Agregar Navío
                    </a>
                </div>
            </div>
        </div>

        <div class="row tabla-navios">
            <div class="col s12">
                <table class="highlight">
                    <thead>
                        <tr>
                            <th></th>
                            <th>Nombre</th>
                            <th>Matrícula</th>
                            <th>Gerente Asignado</th>
                            <th>Servicio</th>
                        </tr>
                    </thead>
                    <tbody id="tablaNavios">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modalNavio" class="modal">
        <div class="modal-content">
            <h5 id="modalTitulo"></h5> 
            <form id="formNavio" action="" method="post">
                {% csrf_token %}
                <input type="hidden" id="navioMatricula"> 
                
                <div class="input-field">
                    <input id="matriculaBuque" name="matricula_buque" type="text" required>
                    <label for="matriculaBuque">Matrícula</label>
                </div>

                <div class="input-field">
                    <input id="nombreNavio" name="nombre_buque" type="text" required>
                    <label for="nombreNavio">Nombre del navío</label>
                </div>

                <div class="input-field">
                    <select id="gerenteNavio" name="gerente">
                        <option value="" disabled selected>Seleccione un gerente</option>
                    </select>
                    <label for="gerenteNavio">Gerente Asignado</label> 
                </div>

                <div class="input-field">
                    <input id="servicioNavio" name="servicio" type="text">
                    <label for="servicioNavio">Servicio</label>
                </div>
            </form>
        </div>

        <div class="modal-footer">
            <a id="btnEliminarNavio" class="waves-effect waves-light btn red left" style="display: none;">
                <i class="material-icons left">delete</i>Eliminar
            </a>
            <a id="btnInventario" class="waves-effect waves-light btn light-blue" style="display: none;">
                <i class="material-icons left">inventory</i>Ir a Inventario
            </a>
            <button type="submit" form="formNavio" class="waves-effect waves-light btn">
                <span id="btnAccion"></span> 
            </button>
            <a href="#!" class="modal-close waves-effect btn-flat">Cancelar</a>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- INICIALIZACIÓN DE MATERIALIZE (Asegúrate de que esto esté presente y correcto) ---
        const elemsModal = document.querySelectorAll('.modal');
        M.Modal.init(elemsModal); 
        const modalNavioInstance = M.Modal.getInstance(document.getElementById('modalNavio'));
        
        // Variables globales
        let navios = [];
        let gerentesDisponibles = []; 
        let allGerentesCache = {}; 
        let navioSeleccionado = null; 

        // Elementos del DOM
        const tablaNavios = document.getElementById('tablaNavios');
        const formNavio = document.getElementById('formNavio');
        const btnEditar = document.getElementById('btnEditarNavio');
        const btnInventario = document.getElementById('btnInventario');
        const modalTitulo = document.getElementById('modalTitulo');
        const btnAccion = document.getElementById('btnAccion');
        const navioMatriculaInput = document.getElementById('navioMatricula'); 
        const selectGerente = document.getElementById('gerenteNavio');
        const btnEliminar = document.getElementById('btnEliminarNavio');
        const searchInput = document.getElementById('search');
        const btnAgregarNavio = document.getElementById('btnAgregarNavio'); 
        const matriculaBuqueInput = document.getElementById('matriculaBuque');

        // Cargar datos iniciales: navíos y gerentes
        cargarDatosIniciales();

        // --- Event Listeners ---
        tablaNavios.addEventListener('click', function(e) {
            const fila = e.target.closest('tr'); 
            if (!fila || fila.classList.contains('no-data-row')) { 
                resetSeleccion(); 
                return;
            }

            document.querySelectorAll('#tablaNavios tr').forEach(row => {
                row.classList.remove('selected');
            });
            
            fila.classList.add('selected');

            navioSeleccionado = navios.find(n => String(n.matricula_buque) === fila.dataset.matricula); 

            if (navioSeleccionado) {
                btnEditar.style.display = 'inline-block';
                btnInventario.style.display = 'inline-block';
                btnEliminar.style.display = 'inline-block'; 
            } else {
                btnEditar.style.display = 'none';
                btnInventario.style.display = 'none';
                btnEliminar.style.display = 'none';
            }
        });

        btnAgregarNavio.addEventListener('click', function() {
            prepararModalParaAgregar();
            modalNavioInstance.open(); 
        });

        btnEditar.addEventListener('click', function() {
            if (!navioSeleccionado) {
                M.toast({html: 'Por favor, seleccione un navío para ver su información.', classes: 'orange'});
                return;
            }
            prepararModalParaEditar(navioSeleccionado);
            modalNavioInstance.open(); 
        });

        btnInventario.addEventListener('click', function() {
            if (!navioSeleccionado) {
                M.toast({html: 'Por favor, seleccione un navío para ver su inventario.', classes: 'orange'});
                return;
            }
            window.location.href = `inventario/${navioSeleccionado.matricula_buque}/`; 
        });

        btnEliminar.addEventListener('click', function() {
            if (!navioSeleccionado) {
                M.toast({html: 'Por favor, seleccione un navío para eliminar.', classes: 'orange'});
                return;
            }

            if (confirm(`¿Estás seguro de eliminar el navío "${navioSeleccionado.nombre_buque}"? Esta acción es irreversible.`)) {
                axios.delete(`/api/navios/${navioSeleccionado.matricula_buque}/`) 
                    .then(() => {
                        M.toast({html: 'Navío eliminado correctamente', classes: 'green'});
                        modalNavioInstance.close(); 
                        cargarDatosIniciales(); 
                    })
                    .catch(error => {
                        const errorMessage = error.response && error.response.data && error.response.data.error ? error.response.data.error : 'Hubo un problema al eliminar el navío.';
                        M.toast({html: `Error: ${errorMessage}`, classes: 'red'});
                    });
            }
        });

        formNavio.addEventListener('submit', function(event) {
            event.preventDefault(); 

            const matriculaOriginalParaPut = navioMatriculaInput.value; 
            
            const datos = {
                nombre_buque: document.getElementById('nombreNavio').value.trim(),
                matricula_buque: matriculaBuqueInput.value.trim(), 
                servicio: document.getElementById('servicioNavio').value.trim() || null, 
                carnet_gerente: selectGerente.value ? selectGerente.value : null, 
            };

            if (!datos.nombre_buque) { M.toast({html: 'El nombre del navío es obligatorio.', classes: 'red'}); return; }
            if (!datos.matricula_buque) { M.toast({html: 'La matrícula es obligatoria.', classes: 'red'}); return; }
            
            if (matriculaOriginalParaPut) { 
                // Lógica de actualización (PUT)
                axios.put(`/api/navios/${matriculaOriginalParaPut}/`, datos) 
                    .then(response => {
                        M.toast({html: response.data.message || 'Navío actualizado correctamente', classes: 'green'});
                        modalNavioInstance.close(); 
                        cargarDatosIniciales(); 
                    })
                    .catch(error => {
                        const errorMessage = error.response && error.response.data && error.response.data.error ? error.response.data.error : 'Hubo un problema al actualizar.';
                        M.toast({html: `Error: ${errorMessage}`, classes: 'red'});
                    });
            } else { 
                // Lógica de creación (POST) - AQUI ES DONDE AÑADIMOS LA VALIDACIÓN OBLIGATORIA
                if (!datos.carnet_gerente || datos.carnet_gerente === "") { // <--- AÑADIDA VALIDACIÓN
                    M.toast({html: 'Debe seleccionar un gerente para crear un navío.', classes: 'red'});
                    return; 
                }

                axios.post('/api/navios/', datos)
                    .then(response => {
                        M.toast({html: response.data.message || 'Navío agregado correctamente', classes: 'green'});
                        modalNavioInstance.close(); 
                        cargarDatosIniciales(); 
                    })
                    .catch(error => {
                        const errorMessage = error.response && error.response.data && error.response.data.error ? error.response.data.error : 'Hubo un problema al agregar.';
                        M.toast({html: `Error: ${errorMessage}`, classes: 'red'});
                    });
            }
        });


        // --- Funciones auxiliares (sin cambios en la lógica, solo para contexto) ---

        function prepararModalParaAgregar() {
            formNavio.reset(); 
            navioMatriculaInput.value = ''; 
            matriculaBuqueInput.readOnly = false; 
            modalTitulo.textContent = 'Agregar navío'; 
            btnAccion.textContent = 'Registrar'; 
            btnEliminar.style.display = 'none'; 
            btnInventario.style.display = 'none'; 

            M.FormSelect.getInstance(selectGerente)?.destroy(); 
            selectGerente.value = "";
            cargarSelectGerentes(null);
            M.FormSelect.init(selectGerente); 
            
            const labelGerente = document.querySelector('label[for="gerenteNavio"]');
            if (labelGerente) { 
                labelGerente.classList.remove('active');
            }
            M.updateTextFields(); 
        }

        async function prepararModalParaEditar(navio) {
            modalTitulo.textContent = 'Informacion del navio'; 
            btnAccion.textContent = 'Actualizar'; 
            btnEliminar.style.display = 'inline-block'; 
            btnInventario.style.display = 'inline-block'; 

            navioMatriculaInput.value = navio.matricula_buque.trim(); 
            document.getElementById('nombreNavio').value = navio.nombre_buque.trim();
            matriculaBuqueInput.value = navio.matricula_buque.trim();
            matriculaBuqueInput.readOnly = true; 
            document.getElementById('servicioNavio').value = navio.servicio ? navio.servicio.trim() : ''; 
            
            M.FormSelect.getInstance(selectGerente)?.destroy(); 

            await cargarSelectGerentes(navio.carnet_gerente); 

            selectGerente.value = navio.carnet_gerente ? String(navio.carnet_gerente) : ""; 
            
            M.FormSelect.init(selectGerente);
            
            const labelGerente = document.querySelector('label[for="gerenteNavio"]');
            if (labelGerente) { 
                if (selectGerente.value !== "") {
                    labelGerente.classList.add('active'); 
                } else {
                    labelGerente.classList.remove('active');
                }
            } 
            M.updateTextFields(); 
        }

        function resetSeleccion() {
            navioSeleccionado = null;
            document.querySelectorAll('#tablaNavios tr').forEach(row => {
                row.classList.remove('selected');
            });
            btnEditar.style.display = 'none';
            btnInventario.style.display = 'none';
            btnEliminar.style.display = 'none'; 
        }

        async function cargarDatosIniciales() {
            try {
                const gerentesDisponiblesResponse = await axios.get('/api/gerentes/list/');
                gerentesDisponibles = gerentesDisponiblesResponse.data;

                const naviosResponse = await axios.get('/api/navios/');
                navios = naviosResponse.data;
                
                allGerentesCache = {};
                navios.forEach(n => {
                    if (n.carnet_gerente && n.nombre_gerente_asignado) {
                        allGerentesCache[String(n.carnet_gerente)] = n.nombre_gerente_asignado;
                    }
                });
                gerentesDisponibles.forEach(g => { 
                    allGerentesCache[String(g.carnet_gerente)] = g.nombre_gerente;
                });

                cargarSelectGerentes(null); 
                
                const hayNaviosRegistrados = navios.length > 0; 
                cargarTablaNavios(navierosFiltrados(), hayNaviosRegistrados); 
                resetSeleccion(); 
            } catch (error) {
                const errorMessage = error.response && error.response.data && error.response.data.error ? error.response.data.error : 'Error al cargar datos. Verifique la conexión o el servidor.';
                M.toast({html: `Error: ${errorMessage}`, classes: 'red'});
            }
        }

        async function cargarSelectGerentes(gerenteActualCarnet = null) {
            M.FormSelect.getInstance(selectGerente)?.destroy(); 

            // Creamos una opción "vacía" que NO PUEDE SER SELECCIONADA si es obligatorio
            const defaultOption = document.createElement('option');
            defaultOption.value = ""; 
            defaultOption.disabled = true; // Hacerla deshabilitada
            defaultOption.selected = true; // Seleccionada por defecto
            defaultOption.textContent = "Seleccione un gerente"; // Texto para el usuario
            
            selectGerente.innerHTML = ''; 
            selectGerente.appendChild(defaultOption);

            let gerentesParaSelect = [...gerentesDisponibles]; 

            if (gerenteActualCarnet && String(gerenteActualCarnet) !== "") {
                const isAlreadyInList = gerentesParaSelect.some(g => String(g.carnet_gerente) === String(gerenteActualCarnet));
                if (!isAlreadyInList) {
                    const nombreGerenteActual = allGerentesCache[String(gerenteActualCarnet)];
                    if (nombreGerenteActual) {
                        gerentesParaSelect.push({
                            carnet_gerente: gerenteActualCarnet,
                            nombre_gerente: nombreGerenteActual
                        });
                    } else {
                        console.warn(`Nombre para gerente ${gerenteActualCarnet} no encontrado en caché.`);
                    }
                }
            }

            gerentesParaSelect.sort((a, b) => a.nombre_gerente.localeCompare(b.nombre_gerente));

            gerentesParaSelect.forEach(g => {
                const option = document.createElement('option');
                option.value = String(g.carnet_gerente); 
                option.textContent = g.nombre_gerente; 
                selectGerente.appendChild(option);
            });
            
            M.FormSelect.init(selectGerente); 
        }

        function cargarTablaNavios(datosVisibles, allNaviosExist) { 
            tablaNavios.innerHTML = ''; 

            if (datosVisibles.length === 0) {
                const tr = document.createElement('tr');
                tr.classList.add('no-data-row');
                let message = '';
                
                if (searchInput.value.trim() === '' && !allNaviosExist) {
                    message = 'No hay navíos registrados en el sistema.';
                } else {
                    message = 'No hay coincidencias para tu búsqueda.';
                }

                tr.innerHTML = `<td colspan="5" class="center-align">${message}</td>`;
                tablaNavios.appendChild(tr);
                return; 
            }
            
            datosVisibles.forEach(n => {
                const tr = document.createElement('tr');
                tr.dataset.matricula = n.matricula_buque; 
                const nombreGerenteMostrar = n.nombre_gerente_asignado || 'No asignado'; 

                tr.innerHTML = `
                    <td><i class="material-icons">directions_boat</i></td>
                    <td>${n.nombre_buque}</td>
                    <td>${n.matricula_buque}</td>
                    <td>${nombreGerenteMostrar}</td>
                    <td>${n.servicio || 'N/A'}</td>
                `;
                tablaNavios.appendChild(tr);
            });
        }

        searchInput.addEventListener('input', function() {
            cargarTablaNavios(navierosFiltrados(), true); 
            resetSeleccion(); 
        });

        function navierosFiltrados() {
            const filtro = searchInput.value.toLowerCase().trim();
            if (!filtro) return navios; 
            return navios.filter(n =>
                n.nombre_buque.toLowerCase().includes(filtro) ||
                n.matricula_buque.toLowerCase().includes(filtro) || 
                (n.servicio && n.servicio.toLowerCase().includes(filtro)) ||
                (n.nombre_gerente_asignado && n.nombre_gerente_asignado.toLowerCase().includes(filtro)) 
            );
        }
    });
</script>
</body>
</html>