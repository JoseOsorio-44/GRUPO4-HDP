{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>OceanTrack - Inventario</title>
  <link rel="stylesheet" href="{% static 'css/materialize.min.css' %}">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    .info-navio {
      margin-top: 20px;
      padding: 15px;
      background-color: #e3f2fd;
      border-radius: 5px;
    }
    .tabla-productos {
      margin-top: 20px;
    }
    .tabla-productos tr.selected {
      background-color: #e3f2fd !important;
    }
    #btnEditarProducto, #btnEliminarProducto {
      display: none;
    }
    .file-field .btn {
      margin-top: 10px;
    }
    .fecha-caducidad {
      display: none;
    }
  </style>
</head>

<body>
  <script src="{% static 'js/materialize.min.js' %}"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

      <nav class="blue darken-1">
        <div class="nav-wrapper">
            <a href="{% url 'admin_view' %}" class="brand-logo">
              <img src="{% static 'images/LogoB.png' %}" alt="OceanTrack" style="height:55px; margin-left:14px; margin-top:6px;">
            <span style="margin-left: 10px; font-size: 2.5rem; position: relative; top: -14px;">OceanTrack</span>
            </a>
            <a href="#!" class="brand-logo center" style="font-size: 1rem;">Catalogo</a>
            <ul class="right hide-on-med-and-down">
                <li><a href="{% url 'buques' %}"><i class="material-icons left">directions_boat</i>Volver a Navíos</a></li>
                <li><a href="{% url 'logout' %}"><i class="material-icons right">exit_to_app</i>Salir</a></li>
            </ul>
        </div>
    </nav>

  <!-- Información del navío -->
  <div class="container info-navio">
    <div class="row">
      <div class="col s12 m6">
        <h5 id="nombreNavio">Cargando información del navío...</h5>
      </div>
      <div class="col s12 m6">
        <h5 id="gerenteNavio"></h5>
      </div>
    </div>
  </div>

  <!-- Formulario de búsqueda -->
  <div class="container">
    <div class="row" style="margin-top: 20px; align-items: center;">
      <!-- Barra de búsqueda -->
      <div class="col s12 m6">
        <div class="input-field">
          <i class="material-icons prefix">search</i>
          <input id="search" type="text" placeholder="Buscar producto">
          <label class="active" for="search">Buscar</label>
        </div>
      </div>

      <!-- Selector de categoría -->
      <div class="col s6 m2">
        <div class="input-field">
          <select id="filtroCategoria">
            <option value="" selected>Todas</option>
            <option value="provision">Provisión</option>
            <option value="repuesto">Repuesto</option>
          </select>
          <label>Categorías</label>
        </div>
      </div>

      <!-- Botón de alertas -->
      <div class="col s6 m1 center">
        <a id="btnAlertas" class="btn yellow darken-2" style="margin-top: 20px;">
          <i class="material-icons">warning</i>
        </a>
      </div>

      <!-- Botón agregar producto -->
      <div class="col s12 m3">
        <a class="waves-effect waves-light btn red modal-trigger" href="#modalProducto" style="width: 100%; margin-top: 20px;">
          Agregar producto
        </a>
      </div>
    </div>
  </div>

  <!-- Tabla de productos -->
  <div class="container tabla-productos">
    <div class="row">
      <div class="col s12">
        <table class="highlight">
          <thead>
            <tr>
              <th></th>
              <th>Nombre</th>
              <th>Categoría</th>
              <th>Cantidad</th>
              <th>Límite</th>
              <th>Caducidad</th>
            </tr>
          </thead>
          <tbody id="tablaProductos">
            <!-- Los productos se cargarán aquí -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal para agregar/editar producto -->
  <div id="modalProducto" class="modal">
    <div class="modal-content">
      <h5 id="modalTitulo">Agregar producto</h5>
      <form id="formProducto" enctype="multipart/form-data">
        <input type="hidden" id="productoId">
        <input type="hidden" id="navioId">

        <div class="input-field">
          <input id="nombreProducto" name="nombre" type="text" required>
          <label for="nombreProducto">Nombre del producto</label>
        </div>

        <div class="input-field">
          <textarea id="descripcionProducto" name="descripcion" class="materialize-textarea" required></textarea>
          <label for="descripcionProducto">Descripción</label>
        </div>

        <div class="row">
          <div class="input-field col s6">
            <input id="cantidadProducto" name="cantidad" type="number" min="0" required>
            <label for="cantidadProducto">Cantidad</label>
          </div>

          <div class="input-field col s6">
            <input id="limiteProducto" name="limite" type="number" min="0" required>
            <label for="limiteProducto">Límite mínimo</label>
          </div>
        </div>

        <div class="input-field">
          <select id="categoriaProducto" name="categoria" required>
            <option value="" disabled selected>Seleccione categoría</option>
            <option value="provision">Provisión</option>
            <option value="repuesto">Repuesto</option>
          </select>
          <label>Categoría</label>
        </div>

        <div id="fechaCaducidadContainer" class="input-field fecha-caducidad">
          <input id="fechaCaducidad" name="fecha_caducidad" type="text" class="datepicker">
          <label for="fechaCaducidad">Fecha de caducidad</label>
        </div>

        <div class="file-field input-field">
          <div class="btn">
            <span>Imagen</span>
            <input id="imagenProducto" name="imagen" type="file" accept="image/*">
          </div>
          <div class="file-path-wrapper">
            <input class="file-path" type="text" placeholder="Subir imagen del producto">
          </div>
          <div id="previewImagen" style="margin-top: 10px;"></div>
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <a id="btnEliminarProducto" class="waves-effect waves-light btn red left" style="display: none;">
        <i class="material-icons left">delete</i>Eliminar
      </a>
      <button type="submit" form="formProducto" class="waves-effect waves-light btn">
        <span id="btnAccion">Guardar</span>
      </button>
      <a href="#!" class="modal-close waves-effect btn-flat">Cancelar</a>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Inicializar componentes
      var elems = document.querySelectorAll('select');
      M.FormSelect.init(elems);
      
      var modales = document.querySelectorAll('.modal');
      M.Modal.init(modales);
      
      var datepickers = document.querySelectorAll('.datepicker');
      M.Datepicker.init(datepickers, {
        format: 'yyyy-mm-dd',
        i18n: {
          months: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
          monthsShort: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
          weekdays: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
          weekdaysShort: ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'],
          weekdaysAbbrev: ['D', 'L', 'M', 'M', 'J', 'V', 'S'],
          cancel: 'Cancelar',
          clear: 'Limpiar',
          done: 'Aceptar'
        }
      });

      // Variables globales
      let productos = [];
      let productoSeleccionado = null;
      let navioActual = null;
      let gerenteActual = null;

      // Obtener ID del navío de la URL
      const urlParams = new URLSearchParams(window.location.search);
      const navioId = urlParams.get('navio_id');

      // Elementos del DOM
      const nombreNavioEl = document.getElementById('nombreNavio');
      const gerenteNavioEl = document.getElementById('gerenteNavio');
      const tablaProductos = document.getElementById('tablaProductos');
      const formProducto = document.getElementById('formProducto');
      const btnEditar = document.getElementById('btnEditarProducto');
      const btnEliminar = document.getElementById('btnEliminarProducto');
      const modalTitulo = document.getElementById('modalTitulo');
      const btnAccion = document.getElementById('btnAccion');
      const productoIdInput = document.getElementById('productoId');
      const navioIdInput = document.getElementById('navioId');
      const categoriaSelect = document.getElementById('categoriaProducto');
      const fechaCaducidadContainer = document.getElementById('fechaCaducidadContainer');
      const previewImagen = document.getElementById('previewImagen');
      const imagenProducto = document.getElementById('imagenProducto');

      // Cargar datos iniciales
      if (navioId) {
        cargarDatosNavio(navioId);
        cargarProductos(navioId);
        navioIdInput.value = navioId;
      } else {
        M.toast({html: 'No se ha seleccionado un navío', classes: 'red'});
        nombreNavioEl.textContent = 'Navío no seleccionado';
      }

      // Evento para cambiar categoría (mostrar/ocultar fecha caducidad)
      categoriaSelect.addEventListener('change', function() {
        if (this.value === 'provision') {
          fechaCaducidadContainer.style.display = 'block';
        } else {
          fechaCaducidadContainer.style.display = 'none';
        }
      });

      // Evento para previsualizar imagen
      imagenProducto.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            previewImagen.innerHTML = `<img src="${e.target.result}" style="max-width: 200px; max-height: 200px;">`;
          };
          reader.readAsDataURL(file);
        }
      });

      // Evento para seleccionar producto
      tablaProductos.addEventListener('click', function(e) {
        const fila = e.target.closest('tr');
        if (!fila) return;

        document.querySelectorAll('#tablaProductos tr').forEach(row => {
          row.classList.remove('selected');
        });

        fila.classList.add('selected');
        productoSeleccionado = productos.find(p => p.id == fila.dataset.id);

        btnEditar.style.display = 'inline-block';
        btnEliminar.style.display = 'inline-block';
      });

      // Botón editar
      btnEditar.addEventListener('click', function() {
        if (!productoSeleccionado) return;

        modalTitulo.textContent = 'Editar producto';
        btnAccion.textContent = 'Actualizar';
        btnEliminar.style.display = 'inline-block';

        // Llenar formulario
        productoIdInput.value = productoSeleccionado.id;
        document.getElementById('nombreProducto').value = productoSeleccionado.nombre;
        document.getElementById('descripcionProducto').value = productoSeleccionado.descripcion;
        document.getElementById('cantidadProducto').value = productoSeleccionado.cantidad;
        document.getElementById('limiteProducto').value = productoSeleccionado.limite;
        
        // Seleccionar categoría
        const select = M.FormSelect.getInstance(categoriaSelect);
        select.setSelectedValues([productoSeleccionado.categoria]);
        
        // Mostrar fecha de caducidad si es provisión
        if (productoSeleccionado.categoria === 'provision') {
          fechaCaducidadContainer.style.display = 'block';
          const datepicker = M.Datepicker.getInstance(document.getElementById('fechaCaducidad'));
          datepicker.setDate(new Date(productoSeleccionado.fecha_caducidad));
        } else {
          fechaCaducidadContainer.style.display = 'none';
        }

        // Mostrar imagen si existe
        if (productoSeleccionado.imagen) {
          previewImagen.innerHTML = `<img src="${productoSeleccionado.imagen}" style="max-width: 200px; max-height: 200px;">`;
        } else {
          previewImagen.innerHTML = '';
        }

        M.updateTextFields();

        const modal = M.Modal.getInstance(document.getElementById('modalProducto'));
        modal.open();
      });

      // Botón eliminar
      btnEliminar.addEventListener('click', function() {
        if (!productoSeleccionado) return;
        
        if (confirm(`¿Estás seguro de eliminar el producto ${productoSeleccionado.nombre}?`)) {
          axios.delete(`/api/productos/${productoSeleccionado.id}/`)
            .then(response => {
              M.toast({html: 'Producto eliminado exitosamente', classes: 'green'});
              const modal = M.Modal.getInstance(document.getElementById('modalProducto'));
              modal.close();
              cargarProductos(navioId);
            })
            .catch(error => {
              console.error('Error eliminando producto:', error);
              M.toast({html: 'Error al eliminar producto', classes: 'red'});
            });
        }
      });

      // Submit del formulario
      formProducto.addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData();
        formData.append('nombre', document.getElementById('nombreProducto').value.trim());
        formData.append('descripcion', document.getElementById('descripcionProducto').value.trim());
        formData.append('cantidad', document.getElementById('cantidadProducto').value);
        formData.append('limite', document.getElementById('limiteProducto').value);
        formData.append('categoria', categoriaSelect.value);
        formData.append('navio_id', navioId);
        
        if (categoriaSelect.value === 'provision') {
          formData.append('fecha_caducidad', document.getElementById('fechaCaducidad').value);
        }
        
        if (imagenProducto.files[0]) {
          formData.append('imagen', imagenProducto.files[0]);
        }

        const id = productoIdInput.value;
        const metodo = id ? 'put' : 'post';
        const url = id ? `/api/productos/${id}/` : '/api/productos/';

        axios({
          method: metodo,
          url: url,
          data: formData,
          headers: {
            'Content-Type': 'multipart/form-data',
            'X-CSRFToken': getCookie('csrftoken')
          }
        })
        .then(response => {
          M.toast({html: `Producto ${id ? 'actualizado' : 'registrado'} exitosamente`, classes: 'green'});
          const modal = M.Modal.getInstance(document.getElementById('modalProducto'));
          modal.close();
          formProducto.reset();
          previewImagen.innerHTML = '';
          M.updateTextFields();
          cargarProductos(navioId);
        })
        .catch(error => {
          console.error('Error:', error.response ? error.response.data : error.message);
          M.toast({html: `Error al ${id ? 'actualizar' : 'registrar'} producto`, classes: 'red'});
        });
      });

      // Búsqueda y filtrado
      document.getElementById('search').addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const categoria = document.getElementById('filtroCategoria').value;
        
        const filtered = productos.filter(producto => {
          const matchesSearch = producto.nombre.toLowerCase().includes(searchTerm) || 
                              producto.descripcion.toLowerCase().includes(searchTerm);
          const matchesCategory = !categoria || producto.categoria === categoria;
          return matchesSearch && matchesCategory;
        });
        
        renderizarTabla(filtered);
      });

      document.getElementById('filtroCategoria').addEventListener('change', function() {
        document.getElementById('search').dispatchEvent(new Event('input'));
      });

      // Función para cargar datos del navío
      function cargarDatosNavio(id) {
        axios.get(`/api/navios/${id}/`)
          .then(response => {
            navioActual = response.data;
            nombreNavioEl.textContent = navioActual.nombre;
            
            if (navioActual.gerente_id) {
              axios.get(`/api/gerentes/${navioActual.gerente_id}/`)
                .then(response => {
                  gerenteActual = response.data;
                  gerenteNavioEl.textContent = `Gerente: ${gerenteActual.nombre}`;
                })
                .catch(() => {
                  gerenteNavioEl.textContent = 'Gerente: Sin asignar';
                });
            } else {
              gerenteNavioEl.textContent = 'Gerente: Sin asignar';
            }
          })
          .catch(error => {
            console.error('Error cargando navío:', error);
            M.toast({html: 'Error al cargar información del navío', classes: 'red'});
          });
      }

      // Función para cargar productos
      function cargarProductos(navioId) {
        axios.get(`/api/productos/?navio_id=${navioId}`)
          .then(response => {
            productos = response.data;
            renderizarTabla(productos);
          })
          .catch(error => {
            console.error('Error cargando productos:', error);
            M.toast({html: 'Error al cargar productos', classes: 'red'});
          });
      }

      // Función para renderizar tabla
      function renderizarTabla(data = productos) {
        tablaProductos.innerHTML = data.map(producto => `
          <tr data-id="${producto.id}">
            <td><i class="material-icons">${producto.categoria === 'provision' ? 'fastfood' : 'build'}</i></td>
            <td>${producto.nombre}</td>
            <td>${producto.categoria === 'provision' ? 'Provisión' : 'Repuesto'}</td>
            <td>${producto.cantidad}</td>
            <td>${producto.limite}</td>
            <td>${producto.categoria === 'provision' ? (producto.fecha_caducidad || 'N/A') : 'N/A'}</td>
          </tr>
        `).join('');

        productoSeleccionado = null;
        btnEditar.style.display = 'none';
        btnEliminar.style.display = 'none';
      }

      // Función para obtener cookie CSRF
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }

      // Evento para abrir modal de agregar
      document.querySelector('a[href="#modalProducto"].modal-trigger').addEventListener('click', function() {
        modalTitulo.textContent = 'Agregar producto';
        btnAccion.textContent = 'Guardar';
        btnEliminar.style.display = 'none';
        formProducto.reset();
        productoIdInput.value = '';
        previewImagen.innerHTML = '';
        fechaCaducidadContainer.style.display = 'none';
        M.updateTextFields();
      });

      // Botón de alertas
      document.getElementById('btnAlertas').addEventListener('click', function() {
        const productosBajos = productos.filter(p => p.cantidad < p.limite);
        const productosCaducados = productos.filter(p => {
          if (p.categoria === 'provision' && p.fecha_caducidad) {
            const hoy = new Date();
            const caducidad = new Date(p.fecha_caducidad);
            return caducidad < hoy;
          }
          return false;
        });

        let mensaje = '';
        if (productosBajos.length > 0) {
          mensaje += `Productos bajo límite (${productosBajos.length}):\n`;
          mensaje += productosBajos.map(p => `- ${p.nombre} (${p.cantidad}/${p.limite})`).join('\n');
        }
        
        if (productosCaducados.length > 0) {
          if (mensaje) mensaje += '\n\n';
          mensaje += `Productos caducados (${productosCaducados.length}):\n`;
          mensaje += productosCaducados.map(p => `- ${p.nombre} (${p.fecha_caducidad})`).join('\n');
        }

        if (mensaje) {
          alert(mensaje);
        } else {
          M.toast({html: 'No hay alertas', classes: 'green'});
        }
      });
    });
  </script>
</body>
</html>